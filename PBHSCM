# Author: Ce Shi
# Last updated: 2/23/2025
# Description:
The code was created to implement the ML models to predict peripheral blood hematopoietic stem cell mobilization in healthy volunteers.

#####共线性变量和无关变量####
library(ggplot2)
col_types <- sapply(result_value, class)
# 筛选不是数字的列（即不是numeric类型的列）
non_numeric_cols <- col_types != "numeric"

# 提取不是数字的列
result_value_non_numeric <- result_value[, non_numeric_cols]

# 查看结果
print(result_value_non_numeric)

result_value$性别.男1.女2.=as.numeric(result_value$性别.男1.女2.)
result_value$MCHC=as.numeric(result_value$MCHC)
result_value$血小板 =as.numeric(result_value$血小板 )
result_value$尿酸 =as.numeric(result_value$尿酸 )
result_value$肌酐=as.numeric(result_value$肌酐)
result_value$age=as.numeric(result_value$age)
result_value$times =as.numeric(result_value$times )
result_value$收集年份=as.numeric(result_value$收集年份)

colnames(result_value) <- c("Gender", "Neutrophil", "Hemoglobin","RBC","HCT","MCV","MCHC","Platelets","Albumin","Globulin","Triglycerides","TC","LDL","Uric acid","Creatinine","BUN","GFR","BG","Weight","Height","BMI","WBC","Monocyte","Lymphocyte","Day4 CD34+ cell","Total mobilizer dose","Mobilizer dose per body weight","Age","Dosage frequency per day","Year of data collection")


# 步骤1: 计算相关矩阵
cor_matrix <- cor(result_value, use = "complete.obs")  # 使用complete.obs来处理缺失值
test_result <- cor.test(result_value$`Day4 CD34+ cell`, result_value$BUN, method = "pearson")
# 步骤2: 检查相关矩阵
print(cor_matrix)
write.csv(cor_matrix, "cor_matrix.csv", row.names = TRUE)

# 步骤3: 使用阈值来找出共线性变量
# 例如，我们可以设置阈值为0.7，这意味着任何相关性高于0.7的变量对将被视为共线性
threshold <- 0.7
high_cor_var <- findCorrelation(cor_matrix, cutoff = threshold, verbose = TRUE)

# 如果需要，你可以可视化相关矩阵的热图来更好地理解变量之间的关系
ggplot(data = as.data.frame(as.table(cor_matrix)), aes(Var1, Var2, fill = Freq)) +
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white", 
                       midpoint = 0, limit = c(-1,1), space = "Lab", 
                       name="Pearson\nCorrelation") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, size = 12, hjust = 1),
        axis.text.y = element_text(size = 12)) +
  coord_fixed() +
  ggtitle("Correlation Matrix Heatmap")

# 步骤4: 排除共线性变量
result_value_clean <- result_value[, !names(result_value) %in% names(result_value)[high_cor_var]]
